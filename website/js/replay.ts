import { Point, Rectangle } from './coords';
import * as sprites from './sprites';
import * as util from './util';
import * as wiamap from './wiamap';

var temporaryTestReplayData = {"user":"|lDgAl|Luffy","level":"downhill","inputs":["NyJXoFgCCKSgUwT629I/","N2wUYEIthPQgThDiBGVMARwEIEg1MoTmVv8=","PREgEIEBMHWgAb0NGIBlBhIgEIAJ2ATgAgQBKABFAFrwDw==","OwEwEgALAaAQAAoBsBAAHwFAEgAKAcAQAAsBIBIACwFAEQAKAbAQACUBABIACwGgEAAoAaAQADYBoBAACwGAFwALAbAQAAoB8A8=","WQHAFgAQAaAQAAwBkBEAFAGwEAALAWAVABEBsBAACgEQEQAVAcATAAQBABcAEgGwEAALAbAQAAoB8A8=","/rCsADsA/tCiANsA/w==","/rCmAFsA+QqwBYCoAOsA/w=="],"sync":[{"entity_uid":2,"corrections":[[0,50160,19770,0,0],[8,50160,19680,0,0],[56,50200,19680,30300,0],[64,50779,19680,51047,0],[72,51442,19319,49200,-50342],[80,52109,18720,52200,0],[88,52806,18740,52200,0],[96,53510,19680,58933,0],[104,54295,19680,58933,0],[112,55078,19680,58258,0],[120,55854,19680,58258,0],[128,56631,19680,58258,0],[136,57404,19680,55313,0],[144,58106,19680,52200,0],[152,58802,19680,52200,0],[160,59483,19680,49511,0],[168,60139,18872,49200,-51379],[176,60836,18740,53247,0],[184,61544,18740,53101,0],[192,62252,18740,53083,0],[200,62958,18844,52784,81408],[208,63661,20229,52591,127488],[216,64393,22119,100677,100677],[224,65735,23461,100636,100636],[232,67077,24803,100636,100636],[240,68473,26055,127917,62389],[248,70200,26120,125002,-60967],[256,71866,25303,123553,-59354],[264,73174,25283,97472,0],[272,74453,25527,89980,87168],[280,75566,26989,77474,133248],[288,76541,29065,69107,179328],[296,77892,30814,113753,113753],[304,79409,32331,113753,113753],[312,80986,33748,144403,70430],[320,83026,34324,147378,87168],[328,84823,35040,127536,0],[336,86523,35040,127536,0],[344,88223,35040,127536,0],[352,89924,35040,127536,0],[360,91614,35040,121136,0],[368,92763,34431,96444,-60318],[376,93611,33966,85606,-39432],[384,94311,33701,77752,-22440],[392,94496,33679,80123,0],[400,95564,33679,80123,0],[408,96612,33923,74360,87168],[416,97552,35385,67024,133248],[424,98412,37431,106721,106721],[432,99948,38671,135408,66043],[440,101900,38880,148929,0],[448,103885,38880,148929,0],[456,105871,38880,148929,0],[464,107424,38880,148929,0],[472,109099,39273,121768,92928],[480,110563,40811,98739,139008],[488,111962,42326,106613,106613],[496,113520,43537,134590,65644],[504,115481,43680,149745,0],[512,117477,43680,149745,0],[520,119410,43680,133745,0],[528,121014,42907,107312,-52991],[536,122314,42056,88699,-56217],[544,123413,41230,76617,-27993],[552,124378,41005,68534,-5875],[560,125261,41736,86643,42258],[568,126540,41760,96399,0],[576,127825,41760,96399,0],[584,129110,41760,96399,0],[592,130396,41760,96399,0],[600,131650,41374,87654,-68313],[608,132737,40667,75918,-38015],[616,133694,40136,67908,-73727],[624,134412,39280,63533,-46621],[632,134992,38933,60757,-27670],[640,135573,38648,58519,-80639],[648,135612,38595,58394,-78335],[656,136376,37792,56343,-44236],[664,137118,37375,54971,-18777],[672,137844,37263,54054,0],[680,138561,38162,53428,110208],[688,139270,39931,53021,156288],[696,140078,42120,114067,114067],[704,141580,43623,111328,111328],[712,143055,45098,110435,110435],[720,144528,46571,110321,110321],[728,145999,48042,110321,110321],[736,147469,49513,110208,110208],[744,148939,50982,110208,110208],[752,150408,52452,110208,110208],[760,151877,53921,109713,109713],[768,153041,54666,99186,0],[776,153446,54666,93606,0],[792,153490,54666,93028,0],[800,153555,54666,92177,0],[808,153597,54666,91619,0]]},{"entity_uid":3,"corrections":[[0,54829,20280,-7541,-837],[16,54812,20278,-2197,-239],[24,54806,20277,76,11],[32,54808,20277,240,31],[40,54812,20278,283,37],[48,54816,20278,286,37],[56,54820,20279,341,34],[64,54839,20279,2690,41],[72,54898,20274,5661,-1559],[80,54988,20225,7403,-4569],[88,55094,20173,8078,-3280],[96,55187,20169,5827,3229],[104,55289,20220,12035,4850],[112,55561,20295,26884,5118],[120,56017,20341,39418,1872],[128,56613,20312,47898,-4591],[136,57286,20248,51911,-4593],[144,57972,20194,50229,-3620],[152,58636,20153,49261,-2634],[160,59292,20126,48844,-1516],[168,59919,20086,45643,-4205],[176,60531,20037,46403,-2596],[184,61132,20024,44395,404],[192,61712,20054,42949,4187],[200,62273,20168,41553,14082],[208,62905,20577,53783,44389],[216,63769,21446,74382,76409],[224,64941,22496,97466,83962],[232,66366,23658,113983,86924],[240,67959,24702,122569,66234],[248,69631,25346,123521,33490],[256,71139,25675,105497,19777],[264,72416,25897,90409,15714],[272,73581,26134,86530,26003],[280,74767,26765,91125,65373],[288,76033,27948,98867,106402],[296,77466,29392,112538,106536],[304,79012,30973,118159,126091],[312,80620,32597,122430,105747],[320,82334,33581,134473,63892],[328,84151,34263,134161,28833],[336,85885,34449,127806,5430],[344,87588,34421,127260,-6618],[352,89272,34309,125973,-9745],[360,90955,34185,126884,-6830],[368,92535,34120,108333,-4599],[376,93770,34056,81481,-4688],[384,94708,34003,62097,-3282],[392,95376,33964,42013,-2438],[400,95934,33992,44044,5961],[408,96598,34143,54228,19217],[416,97414,34579,66007,41350],[424,98353,35230,74618,49976],[432,99556,35818,103352,39900],[440,101131,36224,128195,26303],[448,102959,36577,142696,27386],[456,104925,36967,150078,31019],[464,106925,37414,147321,34783],[472,108762,37956,131000,55875],[480,110426,38879,120798,75864],[488,111976,39775,113307,60066],[496,113460,40455,112297,41988],[504,115037,40810,124912,17135],[512,116796,40927,136619,2635],[520,118673,40885,141842,-6958],[528,120474,40735,127455,-14061],[536,122005,40542,105089,-14437],[544,123256,40360,85556,-12775],[552,124285,40211,71742,-9593],[560,125165,40148,62570,1270],[568,126076,40208,74273,6101],[576,127162,40296,86527,6577],[584,128386,40370,95334,4306],[592,129689,40365,98630,-3974],[600,131002,40285,97572,-7675],[608,132244,40165,88536,-9342],[616,133331,40055,75968,-7354],[624,134231,39959,60273,-6987],[632,134928,39892,46837,-2489],[640,135492,39901,39216,2542],[648,135926,39919,26994,353],[656,136252,39928,24739,1427],[664,136611,39968,28522,4267],[672,137026,40052,33060,8469],[680,137531,40344,43575,36580],[688,138234,41050,59828,64282],[696,139166,42035,79741,72414],[704,140476,43015,110686,77635],[712,142078,44098,127040,87220],[720,143820,45395,131252,102779],[728,145539,46766,126233,102152],[736,147189,48197,121846,114237],[744,148768,49738,115621,110563],[752,150273,50994,111771,80053],[760,151835,51894,123043,59110],[768,153569,52442,132030,21290],[776,155274,52544,123603,-1082],[784,156717,52429,92960,-12817],[792,157688,52220,58492,-17383],[800,158280,51994,35074,-15073],[808,158635,51834,21076,-9845],[816,158848,51731,12629,-6259]]},{"entity_uid":223,"corrections":[[336,93420,32966,0,-11166],[344,93420,32880,0,-500],[352,93420,32896,0,3500],[360,93420,32966,0,7500],[368,93420,33090,0,11500],[376,93420,33266,0,15500]]},{"entity_uid":232,"corrections":[[744,156110,54143,0,-15833],[752,156110,53994,0,-5166],[760,156110,53978,0,2000],[768,156110,54028,0,6000],[776,156110,54131,0,10000],[784,156110,54288,0,-19166],[792,156110,54095,0,-8500],[800,156110,54068,97,-24]]},{"entity_uid":234,"corrections":[[752,157830,51879,0,-5166],[760,157830,51863,0,2000],[768,157830,51913,0,6000],[776,157830,52016,0,10000],[784,157830,52173,0,-19166],[792,157830,52111,85,-51]]},{"entity_uid":236,"corrections":[[760,159670,53913,0,2000],[768,159670,53963,0,6000],[776,159670,54066,0,10000],[784,159670,54223,0,-19166],[792,159670,54030,0,-8500],[800,159670,53977,0,500],[808,159670,53978,99,-12]]},{"entity_uid":319,"corrections":[[576,135520,38303,0,-17833],[584,135520,38127,0,-7166],[592,135520,38090,0,1000],[600,135520,38126,0,5000],[608,135520,38216,0,9000],[616,135520,38360,0,13000],[624,135520,38556,0,17000],[632,135520,38356,0,-21166]]},{"entity_uid":329,"corrections":[]}]};

interface Replay {
    user: string;
    level: string;
    inputs: string[];
    sync: ReplayEntity[];
}

interface ReplayEntity {
    entity_uid: number;
    corrections: number[][];
}

export class Replayer implements wiamap.Layer {
    public def = { zindex: 199, parallax: 1 };
    public stage = new PIXI.Container();
    private replays = [temporaryTestReplayData];
    private frame = -180;

    constructor(private widget: wiamap.Widget) { }

    public update(viewport: wiamap.Viewport, canvasRect: Rectangle, worldRect: Rectangle) {
        ++this.frame;  // TODO: handle slow PCs, update multiple "frames" per frame if necessary
        if (this.frame < 0 || this.frame > 4000)
            return;

        _.each(this.replays, replay => {
            this.processReplay(replay, viewport, canvasRect, worldRect);
        });
    }

    private processReplay(replay: Replay, viewport: wiamap.Viewport, canvasRect: Rectangle, worldRect: Rectangle) {
        var playerEntity = _.find(replay.sync, s => s.entity_uid === 2);
        var cameraEntity = _.find(replay.sync, s => s.entity_uid === 3);
        var playerCor = interpolate(playerEntity, this.frame);
        if (!playerCor)
            return;
        var cameraCor = interpolate(cameraEntity, this.frame);
        this.widget.viewport.position = new Point(cameraCor[1] / 10, cameraCor[2] / 10);

        this.stage.removeChildren();
        var playerPos = viewport.worldToScreenP(this, new Point(playerCor[1] / 10, playerCor[2] / 10 - 24));
        var sprite = sprites.loadSprite('hud/head_1_0001', 200);
        if (sprite)
            util.addDustforceSprite(this.stage, sprite, {
                posX: playerPos.x - canvasRect.left,
                posY: playerPos.y - canvasRect.top,
                scale: viewport.zoom * 2,
            });
    }
}

function interpolate(entity: ReplayEntity, frame: number) {
    var index = _.sortedIndex(entity.corrections, [frame], c => c[0]);
    var b = entity.corrections[index];
    if (!b || b[0] === frame)
        return b;
    var a = entity.corrections[index - 1];
    var p = (frame - a[0]) / (b[0] - a[0]);
    return [frame, a[1] * (1 - p) + b[1] * p, a[2] * (1 - p) + b[2] * p];
}
